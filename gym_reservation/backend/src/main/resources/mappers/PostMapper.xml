<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gym.mapper.xml.PostMapper">

  <!-- ê²°ê³¼ ë§¤í•‘: PostResponse DTOì— DB ì»¬ëŸ¼ì„ ë§¤í•‘ -->
  <resultMap id="PostResultMap" type="com.gym.domain.post.PostResponse">
    <id     property="postId"       column="post_id"/>
    <result property="boardId"      column="board_id"/>
    <result property="boardPostNo"  column="board_post_no"/>  <!-- [250924ì¶”ê°€] ê²Œì‹œíŒë³„ ë²ˆí˜¸ -->
    <result property="postTitle"    column="post_title"/>
    <result property="postContent"  column="post_content"/>
    <result property="memberId"     column="member_id"/>
    <result property="memberName"   column="member_name"/>
    <result property="postRegDate"  column="post_reg_date"/>
    <result property="postViewCount" column="post_view_count"/>
    <result property="postNotice"   column="post_notice"/>
    <result property="postSecret"   column="post_secret"/>
    <result property="postType"     column="post_type"/>
  </resultMap>

  <!-- ê²Œì‹œê¸€ ë“±ë¡ -->
  <!-- ===== [ì›ë³¸ ë³´ì¡´: BEFORE selectKey ë°©ì‹] =====
  <insert id="insertPost" parameterType="com.gym.domain.post.Post" keyProperty="postId">
    <selectKey keyProperty="postId" resultType="long" order="BEFORE">
      SELECT post_seq.NEXTVAL FROM dual
    </selectKey>
    INSERT ...
  </insert>
  -->

  <!-- ===== [ì›ë³¸ ë³´ì¡´: NEXTVAL + AFTER CURRVAL ë°©ì‹] =====
  <insert id="insertPost" parameterType="com.gym.domain.post.Post" keyProperty="postId">
    INSERT INTO post_tbl (
      post_id, board_id, post_title, post_content, member_id,
      post_reg_date, post_mod_date, post_view_count, post_notice, post_secret, post_type
    ) VALUES (
      post_seq.NEXTVAL,
      #{boardId}, #{postTitle}, #{postContent}, #{memberId},
      SYSDATE, NULL, 0,
      <choose>
        <when test="postNotice"> 'Y' </when>
        <otherwise> 'N' </otherwise>
      </choose>,
      <choose>
        <when test="postSecret"> 'Y' </when>
        <otherwise> 'N' </otherwise>
      </choose>,
      #{postType}
    )
    <selectKey keyProperty="postId" resultType="long" order="AFTER">
      SELECT post_seq.CURRVAL FROM dual
    </selectKey>
  </insert>
  -->

  <!-- 25ë…„ 9ì›” 11ì¼ ìµœì¢…ë³¸: íŠ¸ë¦¬ê±°ê°€ PK ì±„ì›€ â†’ VALUESì—ëŠ” NULL, AFTERì—ì„œ CURRVAL íšŒìˆ˜ -->
  <!-- [250924ì •ë¦¬] board_post_noëŠ” DB íŠ¸ë¦¬ê±°ë‚˜ ë³„ë„ ë¡œì§ì—ì„œ ì±„ì›Œì§(INSERTì—ì„œëŠ” ê´€ì—¬í•˜ì§€ ì•ŠìŒ) -->
  <insert id="insertPost"
          parameterType="com.gym.domain.post.Post"
          keyProperty="postId">
    INSERT INTO post_tbl (
      post_id, board_id, post_title, post_content, member_id,
      post_reg_date, post_mod_date, post_view_count,
      post_notice, post_secret, post_type
    ) VALUES (
      NULL,
      #{boardId}, #{postTitle}, #{postContent}, #{memberId},
      SYSDATE, NULL, 0,
      <choose><when test="postNotice"> 'Y' </when><otherwise> 'N' </otherwise></choose>,
      <choose><when test="postSecret"> 'Y' </when><otherwise> 'N' </otherwise></choose>,
      #{postType}
    )
    <!-- ðŸ”½ ê°™ì€ ì„¸ì…˜ ë‚´ì—ì„œ ë°©ê¸ˆ INSERTëœ ì‹œí€€ìŠ¤ì˜ CURRVALë¡œ PK íšŒìˆ˜ -->
    <selectKey keyProperty="postId" resultType="long" order="AFTER">
      SELECT post_seq.CURRVAL FROM dual
    </selectKey>
  </insert>

  <!-- ê²Œì‹œê¸€ ìˆ˜ì •: ìˆ˜ì •ì¼ SYSDATE, boolean â†’ 'Y'/'N' -->
  <!-- parameterType=PostResponse ìœ ì§€ (ì¸í„°íŽ˜ì´ìŠ¤ì™€ ì¼ì¹˜) -->
  <!-- [ì°¸ê³ ] WHEREëŠ” ê¸°ì¡´ post_id ë‹¨ë…ì„ ìœ ì§€ -->
  <update id="updatePost" parameterType="com.gym.domain.post.PostResponse">
    UPDATE post_tbl SET
      post_title    = #{postTitle},
      post_content  = #{postContent},
      post_mod_date = SYSDATE,
      post_notice =
        <choose>
          <when test="postNotice == true"> 'Y' </when>
          <otherwise> 'N' </otherwise>
        </choose>,
      post_secret =
        <choose>
          <when test="postSecret == true"> 'Y' </when>
          <otherwise> 'N' </otherwise>
        </choose>,
      post_type = #{postType}
    WHERE post_id = #{postId}
  </update>

  <!-- ê²Œì‹œíŒë³„ ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ (íŽ˜ì´ì§•, ê²€ìƒ‰, ê³µì§€ í•„í„° í¬í•¨) -->
  <select id="selectPostsByBoard" resultMap="PostResultMap" parameterType="map">
    SELECT
      p.post_id,
      p.board_id,
      p.board_post_no,                         <!-- âœ” ì¶”ê°€ -->
      p.post_title, p.post_content, p.member_id,
      m.member_name,
      p.post_reg_date, p.post_view_count, p.post_notice, p.post_secret, p.post_type
    FROM post_tbl p
    LEFT JOIN member_tbl m ON p.member_id = m.member_id
    WHERE p.board_id = #{boardId}
      <if test="keyword != null and keyword.trim() != ''">
        AND (p.post_title LIKE '%' || #{keyword} || '%' OR p.post_content LIKE '%' || #{keyword} || '%')
      </if>
      <if test="notice != null">
        AND p.post_notice = (CASE WHEN #{notice} THEN 'Y' ELSE 'N' END)
      </if>
    <!-- âœ” ì •ë ¬: ê³µì§€ ìš°ì„  â†’ ê²Œì‹œíŒë³„ ë²ˆí˜¸ ìµœì‹ ìˆœ -->
    ORDER BY
      CASE WHEN p.post_notice = 'Y' THEN 0 ELSE 1 END,
      p.board_post_no DESC
    OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
  </select>

  <!-- ë‹¨ê±´ ì¡°íšŒ -->
  <select id="selectPostById" resultMap="PostResultMap" parameterType="long">
    SELECT
      p.post_id,
      p.board_id,
      p.board_post_no,                         <!-- âœ” ì¶”ê°€ -->
      p.post_title, p.post_content, p.member_id,
      m.member_name,
      p.post_reg_date, p.post_view_count, p.post_notice, p.post_secret, p.post_type
    FROM post_tbl p
    LEFT JOIN member_tbl m ON p.member_id = m.member_id
    WHERE p.post_id = #{postId}
  </select>

  <!-- ì‚­ì œ -->
  <!-- [ì£¼ì˜] ì„œë¹„ìŠ¤ ì‹œê·¸ë‹ˆì²˜ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ ê¸°ì¡´ post_id ë‹¨ë… ì¡°ê±´ì„ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤ -->
  <delete id="deletePostById" parameterType="long">
    DELETE FROM post_tbl WHERE post_id = #{postId}
  </delete>

  <!-- ê°œìˆ˜ -->
  <select id="countPostsByBoard" resultType="int" parameterType="map">
    SELECT COUNT(*)
    FROM post_tbl p
    WHERE p.board_id = #{boardId}
      <if test="keyword != null and keyword.trim() != ''">
        AND (p.post_title LIKE '%' || #{keyword} || '%' OR p.post_content LIKE '%' || #{keyword} || '%')
      </if>
      <if test="notice != null">
        AND p.post_notice = (CASE WHEN #{notice} THEN 'Y' ELSE 'N' END)
      </if>
  </select>

  <!-- â˜… ì¶”ê°€: FK ì‚¬ì „ê²€ì¦ -->
  <select id="existsBoardId" resultType="boolean" parameterType="long">
    SELECT CASE WHEN COUNT(1) > 0 THEN 1 ELSE 0 END
    FROM board_tbl
    WHERE board_id = #{boardId}
  </select>

  <select id="existsMemberId" resultType="boolean" parameterType="string">
    SELECT CASE WHEN COUNT(1) > 0 THEN 1 ELSE 0 END
    FROM member_tbl
    WHERE member_id = #{memberId}
  </select>
  
  <!-- [250925ì¶”ê°€] ê²Œì‹œê¸€ ì¡°íšŒìˆ˜ 1 ì¦ê°€ -->
	<update id="increaseViewCount" parameterType="long">
	    UPDATE post_tbl
	    SET post_view_count = post_view_count + 1
	    WHERE post_id = #{postId}
	</update>
	  

</mapper>
