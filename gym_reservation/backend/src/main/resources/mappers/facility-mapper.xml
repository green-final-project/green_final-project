<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gym.mapper.xml.FacilityQueryMapper">

  <resultMap id="FacilityMap" type="com.gym.domain.facility.Facility">
    <id     column="facility_id"         property="facilityId"/>
    <result column="facility_name"       property="facilityName"/>
    <result column="member_id"           property="memberId"/>
    <result column="instructor_id"       property="instructorId"/>  <!-- ⚠️ [251008] 담당자ID 컬럼 추가 -->
    <result column="facility_phone"      property="facilityPhone"/>
    <result column="facility_content"    property="facilityContent"/>
    <result column="facility_image_path" property="facilityImagePath"/>
    <result column="facility_person_max" property="facilityPersonMax"/>
    <result column="facility_person_min" property="facilityPersonMin"/>
    <result column="facility_use"        property="facilityUse"/>
    <result column="facility_reg_date"   property="facilityRegDate"/>
    <result column="facility_mod_date"   property="facilityModDate"/>
    <result column="facility_open_time"  property="facilityOpenTime"/>
    <result column="facility_close_time" property="facilityCloseTime"/>
    <result column="facility_money"      property="facilityMoney"/>
    <result column="facility_type"   property="facilityType"/> <!-- ⚠️ [251001] 카테고리 매핑 추가 -->
  </resultMap>

  <!-- 목록/검색 -->
  <select id="selectFacilities" resultMap="FacilityMap">
    SELECT
      f.facility_id,
      f.facility_name,
      f.member_id,
      f.instructor_id,
      f.facility_phone,
      f.facility_content,
      f.facility_image_path,
      f.facility_person_max,
      f.facility_person_min,
      f.facility_use,
      f.facility_reg_date,
      f.facility_mod_date,
      TO_CHAR(f.facility_open_time,'HH24:MI') AS facility_open_time,
      TO_CHAR(f.facility_close_time,'HH24:MI') AS facility_close_time,
      f.facility_money,
      f.facility_type <!-- ⚠️ [251001] 카테고리 컬럼 조회 추가 -->
    FROM facility_tbl f
    <where>
      <if test="name != null and name != ''">
        AND f.facility_name LIKE '%' || #{name} || '%'
      </if>
      <if test="facilityUse != null">
        AND f.facility_use = (CASE WHEN #{facilityUse} THEN 'Y' ELSE 'N' END)
      </if>
      <!-- ⚠️ [251001] 카테고리 필터 -->
      <if test="type != null and type != ''">
        AND f.facility_type = #{type} 
      </if>
    </where>

    <!-- 정렬 -->
	<choose>
	  <when test="sort != null and sort != ''">
	    <choose>
	      <!-- name -->
	      <when test="sort == 'name,asc' or sort == 'name'">
	        ORDER BY f.facility_name ASC
	      </when>
	      <when test="sort == 'name,desc'">
	        ORDER BY f.facility_name DESC
	      </when>
	
	      <!-- regdate -->
	      <when test="sort == 'regdate,asc' or sort == 'regdate'">
	        ORDER BY f.facility_reg_date ASC
	      </when>
	      <when test="sort == 'regdate,desc'">
	        ORDER BY f.facility_reg_date DESC
	      </when>
	
	      <!-- 그 외 -->
	      <otherwise>
	        ORDER BY f.facility_id
	      </otherwise>
	    </choose>
	  </when>
	  <otherwise>
	    ORDER BY f.facility_id
	  </otherwise>
	</choose>


    <!-- 페이징{page-1}로 해야지, 1페이지부터 조회됨, 하지만 리턴하는 과정에서 문제가 발생함으로 
    	컨트롤러의 PageResponse<FacilityResponse> pr = facilityService.searchFacilities(name, null, page-1, size, null, facilityType);처리 -->
    <if test="page != null and size != null">
      OFFSET #{page} * #{size} ROWS FETCH NEXT #{size} ROWS ONLY
    </if>
  </select>

  <select id="countFacilities" resultType="long">
    SELECT COUNT(1)
    FROM facility_tbl f
    <where>
      <if test="name != null and name != ''">
        AND f.facility_name LIKE '%' || #{name} || '%'
      </if>
      <if test="facilityUse != null">
        AND f.facility_use = (CASE WHEN #{facilityUse} THEN 'Y' ELSE 'N' END)
      </if>
      <!-- ⚠️ [251001] 카테고리 필터 -->
      <if test="type != null and type != ''">
        AND f.facility_type = #{type} 
      </if>
    </where>
  </select>
  
  <!-- [251008] CMS시설 등록, 담당강사 조회(admin_type 필터 포함) -->
  <resultMap id="MemberMap" type="com.gym.domain.member.Member">
    <id     column="member_id"    property="memberId"/>
    <result column="member_name"  property="memberName"/>
    <result column="member_email" property="memberEmail"/>
    <result column="admin_type"   property="adminType"/>
  </resultMap>
  <select id="selectCmsMembers" resultMap="MemberMap">
	SELECT member_id, member_name, member_email, admin_type
	FROM member_tbl
	WHERE member_role = 'admin'         <!-- 관리자 권한 -->
	AND admin_type = '강사'             <!-- 강사만 조회 -->
	<if test="name != null and name != ''">
		AND member_name LIKE '%' || #{name} || '%'
	</if>
	ORDER BY member_id DESC
  </select>

</mapper>
